# author: Martin Folger (M.Folger@roe.ac.uk)

# Making
#     class files          :  "gmake"         (output: CLASSES_DIR, set in CONF_HOME/make.conf)
#     jar file with classes:  "gmake jar"     (output: JAR_DIR,     set in CONF_HOME/make.conf)
#     javadoc html files   :  "gmake doc"     (output: DOC_DIR,     set in CONF_HOME/make.conf)
#
#     install              :  "gmake install" (output: see CONF_HOME/make.conf)
#     clean                :  "gmake clean"   (deletes class files, jar files, api docs)
#
# The output directories are by default subdirectories of LOCAL_INSTALL_ROOT.
# They can be edited in CONF_HOME/make.conf or changed on the command line (e.g. make JAR_DIR=my_jar_dir jar)

CONF_HOME           = ../conf
include $(CONF_HOME)/make.conf


CLASSES_DIR_FOR_SED = $(shell echo $(CLASSES_DIR) | sed -e 's/\./\\\./g' | sed -e 's/\//\\\//g')
CLASS_FILES         = $(shell find . -name "*.java" | sed -e 's/\.\//$(CLASSES_DIR_FOR_SED)\//g' | sed -e 's/\.java/\.class/g')

CLASSPATH           = $(CLASSES_DIR):$(GEMINI_CP):$(ORAC_CP):$(ODB_CP):$(JSKY_RELATED_CP)

# Should NOT be changed as other packages might rely on the this name!
JAR_FILE            = ot.jar

OT_SCRIPT           = ot

all: classes cfg script


classes: $(CLASSES_DIR) $(CLASS_FILES)

cfg: $(CFG_DIRS) $(LOCAL_INSTALL_ROOT)/classes/jsky/app/ot/cfg $(LOCAL_INSTALL_ROOT)/classes/jsky/app/ot/images 

script: $(BIN_DIR)/$(OT_SCRIPT)

$(LOCAL_INSTALL_ROOT):
	@ -mkdir -p $(LOCAL_INSTALL_ROOT)

$(CLASSES_DIR):
	@ -mkdir -p $(CLASSES_DIR)

$(BIN_DIR):
	@ -mkdir -p $(BIN_DIR)	

$(CFG_DIRS): ../cfg
	cp -r ../cfg $(LOCAL_INSTALL_ROOT)

$(LOCAL_INSTALL_ROOT)/classes/jsky/app/ot/cfg: jsky/app/ot/cfg
	cp -r jsky/app/ot/cfg $(LOCAL_INSTALL_ROOT)/classes/jsky/app/ot

$(LOCAL_INSTALL_ROOT)/classes/jsky/app/ot/images: jsky/app/ot/images
	cp -r jsky/app/ot/images $(LOCAL_INSTALL_ROOT)/classes/jsky/app/ot

	

# default rule 
$(CLASSES_DIR)/%.class: %.java
	$(JAVAC) $(JFLAGS) -d $(CLASSES_DIR) -classpath $(CLASSPATH) -sourcepath . $<


# Bundle everything into jar file
jar: classes
	jar cf $(JAR_DIR)/$(JAR_FILE) -C $(CLASSES_DIR) .

$(CLASSES_DIR)/MANIFEST.MF: $(CONF_HOME)/MANIFEST.MF
	cp $(CONF_HOME)/MANIFEST.MF $(CLASSES_DIR)/MANIFEST.MF

doc:
	-mkdir -p $(DOC_DIR)
	$(JAVADOC) -J-mx50m -d $(DOC_DIR) `find . -name "*.java"`


$(BIN_DIR)/$(OT_SCRIPT): $(BIN_DIR) $(CONF_HOME)/make.conf
	@printf \
	"#!/bin/csh -f\
	\n#########################################################################################\
	\n# This file has been automatically generated by \"gmake\" using the setting in            #\
	\n# $(CONF_HOME)/make.conf. Modifications can be lost after a new make.                    \
	\n# And the format of this script is not really meant to support manual editing.          #\
	\n#########################################################################################\
	\n\
	\n# If there is no appropriate jdk1.3 java in your PATH then set one here.\
	\nset JAVA = java\
	\n\
	\n# Make sure the telescope names in this list correspond to directories in $(CFG_DIRS)\
	\nset TELESCOPE_LIST = \"$(TELESCOPE_LIST)\"\
	\nset TELESCOPE = \"\"\
	\nset INTERNAL_FRAMES = -internalframes\
	\nset USAGE = \"Usage: $$""0 [-h] [-[no]internalframes] <telescope>\\\n  where <telescope> is one of: $$""{TELESCOPE_LIST}\\\n\"\
	\nset CFG_DIRS = $(CFG_DIRS)\
	\n\
	\n##############################\
	\n#                            #\
	\n# Parsing arguments          #\
	\n#                            #\
	\n# ############################\
	\nforeach arg ($$""*)\
	\n  if($$""{arg} == \"-h\") then\
	\n    printf \"$$""{USAGE}\"\
	\n    exit\
	\n  else if($$""{arg} == \"-internalframes\") then\
	\n    set INTERNAL_FRAMES = -internalframes\
	\n  else if($$""{arg} == \"-nointernalframes\") then\
	\n    set INTERNAL_FRAMES = -nointernalframes\
	\n  else if(-d $$""{CFG_DIRS}/$$""{arg}) then\
	\n    set TELESCOPE = $$""{arg}\
	\n  else\
	\n    echo Telescope configuration directory $$""{arg} not found in $$""{CFG_DIRS}\
	\n    printf \"$$""{USAGE}\"\
	\n    exit\
	\n  endif\
	\nend\
	\n\
	\nif($$""{TELESCOPE} == \"\") then\
	\n  printf \"$$""{USAGE}\"\
	\n  exit\
	\nendif\
	\n\
	\nset CFG_TELESCOPE_DIR = $(shell cd $(CFG_DIRS); pwd)/$$""{TELESCOPE}\
	\n\
	\n$$""{JAVA} $(JAVA_FLAGS) -Dot.cfgdir=$$""{CFG_TELESCOPE_DIR}/ -Dot.resource.cfgdir=./ -classpath \
	$(shell echo $(foreach CLASSDIR, $(shell echo $(CLASSPATH):$(JAVAHELP_CP) | sed -e 's/:/ /g'),$(shell cd `dirname $(CLASSDIR)`;pwd)/$(shell basename $(CLASSDIR))) | sed -e 's/ /:/g'):$$""{CFG_TELESCOPE_DIR}\
	jsky.app.ot.OT $$""{INTERNAL_FRAMES}\n"	> $(BIN_DIR)/$(OT_SCRIPT)

	@echo Creating $(BIN_DIR)/$(OT_SCRIPT)
	chmod 755 $(BIN_DIR)/$(OT_SCRIPT)


clean:
	@echo " Delete these directories?\n"\
	      "  $(CLASSES_DIR)\n"\
	      "  $(JAR_DIR)\n"\
	      "  $(DOC_DIR)\n"\
	      "  $(LOCAL_INSTALL_ROOT)\n"\
	      "Yes: return / Cancel: Ctrl-d"
	@read a
	rm -rf $(LOCAL_INSTALL_ROOT) $(CLASSES_DIR) $(JAR_DIR) $(DOC_DIR)


###################################################################
#                    Installation                                 #
###################################################################

ALL_TOOLS           = $(INSTALL_ROOT)/tools/$(notdir $(JHTOOLS_JAR)) \
                      $(INSTALL_ROOT)/tools/$(notdir $(JHALL_JAR)) \
                      $(INSTALL_ROOT)/tools/$(notdir $(DIVA_JAR)) \
                      $(INSTALL_ROOT)/tools/$(notdir $(GRAPH_JAR)) \
                      $(INSTALL_ROOT)/tools/$(notdir $(JACL_JAR)) \
                      $(INSTALL_ROOT)/tools/$(notdir $(JDOM_JAR)) \
                      $(INSTALL_ROOT)/tools/$(notdir $(JSKY_JAR)) \
                      $(INSTALL_ROOT)/tools/$(notdir $(JUNIT_JAR)) \
                      $(INSTALL_ROOT)/tools/$(notdir $(TCLJAVA_JAR)) \
                      $(INSTALL_ROOT)/tools/$(notdir $(XERCES_JAR))

ALL_LIBS            = $(INSTALL_ROOT)/lib/$(notdir $(GEMINI_JAR)) \
                      $(INSTALL_ROOT)/lib/$(notdir $(ORAC_JAR)) \
                      $(INSTALL_ROOT)/lib/$(notdir $(ODB_JAR)) \
                      $(INSTALL_ROOT)/lib/$(notdir $(OT_JAR))


INSTALL_CLASSES_DIR = $(INSTALL_ROOT)/classes
INSTALL_JAR_DIR     = $(INSTALL_ROOT)/lib
INSTALL_DOC_DIR     = $(INSTALL_ROOT)/html/api
INSTALL_BIN_DIR     = $(INSTALL_ROOT)/bin
INSTALL_CFG_DIR     = $(INSTALL_ROOT)/cfg


install:
ifeq ($(INSTALL_ROOT),)
	@echo Usage: gmake "INSTALL_ROOT=myinstall_directory" install
else
	gmake _install
endif


_install: $(INSTALL_ROOT)/lib $(INSTALL_ROOT)/tools $(ALL_LIBS) $(ALL_TOOLS) $(INSTALL_ROOT)/cfg $(INSTALL_ROOT)/bin/ot


$(INSTALL_ROOT)/tools/$(notdir $(JHTOOLS_JAR)): $(JHTOOLS_JAR)
	cp $< $@

$(INSTALL_ROOT)/tools/$(notdir $(JHALL_JAR)): $(JHALL_JAR)
	cp $< $@

$(INSTALL_ROOT)/tools/$(notdir $(DIVA_JAR)): $(DIVA_JAR)
	cp $< $@

$(INSTALL_ROOT)/tools/$(notdir $(GRAPH_JAR)): $(GRAPH_JAR)
	cp $< $@

$(INSTALL_ROOT)/tools/$(notdir $(JACL_JAR)): $(JACL_JAR)
	cp $< $@

$(INSTALL_ROOT)/tools/$(notdir $(JDOM_JAR)): $(JDOM_JAR)
	cp $< $@

$(INSTALL_ROOT)/tools/$(notdir $(JSKY_JAR)): $(JSKY_JAR)
	cp $< $@

$(INSTALL_ROOT)/tools/$(notdir $(JUNIT_JAR)): $(JUNIT_JAR)
	cp $< $@

$(INSTALL_ROOT)/tools/$(notdir $(TCLJAVA_JAR)): $(TCLJAVA_JAR)
	cp $< $@

$(INSTALL_ROOT)/tools/$(notdir $(XERCES_JAR)): $(XERCES_JAR)
	cp $< $@


# Rules for Orac libraries in default location
# If a jar file is not found in its default location the following rules will try to create it directly
# in $(INSTALL_ROOT)/lib rather then create in its default location and then copy it
# into $(INSTALL_ROOT)/lib. This avoids interfering with local setting in other directories.
# These rules will only work if the location of the Orac modules (GEMINI, ORAC, ODB, OT) are equivalent to
# the ones in the cvs directory tree.

$(INSTALL_ROOT)/lib/$(notdir $(GEMINI_JAR)):
ifneq ($(shell if test -f $(GEMINI_JAR) ; then echo exists; fi), )
	cp $(GEMINI_JAR) $@
else
	(cd ../../GEMINI/src; gmake JAR_DIR=$(INSTALL_ROOT)/lib jar)
endif

$(INSTALL_ROOT)/lib/$(notdir $(ORAC_JAR)):
ifneq ($(shell if test -f $(ORAC_JAR) ; then echo exists; fi), )
	cp $(ORAC_JAR) $@
else
	(cd ../../ORAC/src; gmake JAR_DIR=$(INSTALL_ROOT)/lib jar)
endif

$(INSTALL_ROOT)/lib/$(notdir $(ODB_JAR)):
ifneq ($(shell if test -f $(ODB_JAR) ; then echo exists; fi), )
	cp $(ODB_JAR) $@
else
	(cd ../../ODB/src; gmake JAR_DIR=$(INSTALL_ROOT)/lib jar)
endif

$(INSTALL_ROOT)/lib/$(notdir $(OT_JAR)):
ifneq ($(shell if test -f $(OT_JAR) ; then echo exists; fi), )
	cp $(OT_JAR) $@
else
	(cd ../../OT/src; gmake JAR_DIR=$(INSTALL_ROOT)/lib jar)
endif



$(INSTALL_ROOT)/cfg: $(CFG_DIRS)
	cp -r $< $@

$(INSTALL_ROOT)/bin:
	mkdir -p $(INSTALL_ROOT)/bin

$(INSTALL_ROOT)/lib:
	mkdir -p $(INSTALL_ROOT)/lib

$(INSTALL_ROOT)/tools:
	mkdir -p $(INSTALL_ROOT)/tools



$(INSTALL_ROOT)/bin/ot: $(INSTALL_ROOT)/bin
	@printf \
	"#!/bin/csh -f\
	\n#########################################################################################\
	\n# This file has been automatically generated by \"gmake\" using the setting in            #\
	\n# $(CONF_HOME)/make.conf. Modifications can be lost after a new make.                    \
	\n# And the format of this script is not really meant to support manual editing.          #\
	\n#########################################################################################\
 	\n\
	\n# If there is no appropriate jdk1.3 java in your PATH then set one here.\
	\nset JAVA = java\
        \n\
	\ncd \`dirname $$""0\`\
	\n\
	\n# Make sure the telescope names in this list correspond to directories in ../cfg\
	\nset TELESCOPE_LIST = \"$(TELESCOPE_LIST)\"\
	\nset TELESCOPE = \"\"\
	\nset INTERNAL_FRAMES = -internalframes\
	\nset USAGE = \"Usage: $$""0 [-h] [-[no]internalframes] <telescope>\\\n  where <telescope> is one of: $$""{TELESCOPE_LIST}\\\n\"\
	\n\
	\n##############################\
	\n#                            #\
	\n# Parsing arguments          #\
	\n#                            #\
	\n# ############################\
	\nforeach arg ($$""*)\
	\n  if($$""{arg} == \"-h\") then\
	\n    printf \"$$""{USAGE}\"\
	\n    exit\
	\n  else if($$""{arg} == \"-internalframes\") then\
	\n    set INTERNAL_FRAMES = -internalframes\
	\n  else if($$""{arg} == \"-nointernalframes\") then\
	\n    set INTERNAL_FRAMES = -nointernalframes\
	\n  else if(-d ../cfg/$$""{arg}) then\
	\n    set TELESCOPE = $$""{arg}\
	\n  else\
	\n    echo Telescope configuration directory $$""{arg} not found in \`(cd ..; pwd)\`/cfg\
	\n    printf \"$$""{USAGE}\"\
	\n    exit\
	\n  endif\
	\nend\
	\n\
	\nif($$""{TELESCOPE} == \"\") then\
	\n  printf \"$$""{USAGE}\"\
	\n  exit\
	\nendif\
	\n\
	\nset CFG_TELESCOPE_DIR = \`cd ..; pwd\`/cfg/$$""{TELESCOPE}\
	\n\
	\n\
	\n$$""{JAVA} $(JAVA_FLAGS) -Dot.cfgdir=$$""{CFG_TELESCOPE_DIR}/ -Dot.resource.cfgdir=./ -classpath\
	$(shell echo $(addprefix ../tools/, $(notdir $(ALL_TOOLS))) | sed -e 's/ /:/g'):$(shell echo $(addprefix ../lib/, $(notdir $(ALL_LIBS))) | sed -e 's/ /:/g'):$$""{CFG_TELESCOPE_DIR}\
	jsky.app.ot.OT $$""{INTERNAL_FRAMES}\n" > $(INSTALL_ROOT)/bin/ot

	@echo Creating $(INSTALL_ROOT)/bin/ot
	chmod 755 $(INSTALL_ROOT)/bin/ot



