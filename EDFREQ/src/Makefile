# author: Martin Folger (M.Folger@roe.ac.uk)


CONF_HOME           = ../conf
include $(CONF_HOME)/make.conf

# edfreq/FrontEnd.class appears twice in the variable CLASS_FILES.
# Adding it in fornt of the list of all class files speeds up the compilation when all classes have
# to be compiled or recompiled because edfreq.FrontEnd depends on all other classes so that
# compiling it first means that when jdk1.4 or higher is used all the other classes will be
# compiled too, during the compilation of edfreq.FrontEnd. If earlier versions of the jdk are
# not all dependencies are detected by the compiler. Compiling edfreq/FrontEnd.class first
# improves compile time for these earlier jdk's though.
CLASSES_DIR_FOR_SED = $(shell echo $(LOCAL_INSTALL_ROOT)/classes | sed -e 's/\./\\\./g' | sed -e 's/\//\\\//g')
CLASS_FILES         = $(shell find . -name "*.java" | sed -e 's/\.\//$(CLASSES_DIR_FOR_SED)\//g' | sed -e 's/\.java/\.class/g')

CFG_FILES           = $(addprefix $(LOCAL_INSTALL_ROOT)/cfg/, $(shell cd ../cfg; find .))

all: classes script cfg

classes: $(LOCAL_INSTALL_ROOT)/classes $(CLASS_FILES)

script: $(LOCAL_INSTALL_ROOT)/bin $(LOCAL_INSTALL_ROOT)/bin/freqEditor $(LOCAL_INSTALL_ROOT)/bin/freqEditor.bat

#cfg: $(LOCAL_INSTALL_ROOT)/cfg $(CFG_FILES)
cfg: $(LOCAL_INSTALL_ROOT)/cfg $(CFG_FILES)

$(LOCAL_INSTALL_ROOT):
	@ -mkdir -p $(LOCAL_INSTALL_ROOT)

$(LOCAL_INSTALL_ROOT)/classes:
	@ -mkdir -p $(LOCAL_INSTALL_ROOT)/classes

$(LOCAL_INSTALL_ROOT)/bin:
	@ -mkdir -p $(LOCAL_INSTALL_ROOT)/bin	



# default rule 
$(LOCAL_INSTALL_ROOT)/classes/%.class: %.java
	$(JAVAC) -d $(LOCAL_INSTALL_ROOT)/classes -classpath .:$(XERXES_JAR):../../ORAC/install/classes $<

$(LOCAL_INSTALL_ROOT)/cfg: ../cfg
	cp -r ../cfg $(LOCAL_INSTALL_ROOT)

$(LOCAL_INSTALL_ROOT)/cfg/%: ../cfg/%
	rm -rf $@
	cp -r $< $@

# Bundle everything into jar file
jar: classes
ifeq ($(JAR_DIR),)
	@echo Usage: gmake "JAR_DIR=my_jar_directory" jar
else
	gmake _jar
endif


_jar:
	jar cf $(JAR_DIR)/edfreq.jar -C $(LOCAL_INSTALL_ROOT)/classes .


#$(CLASSES_DIR)/MANIFEST.MF: $(CONF_HOME)/MANIFEST.MF
#	cp $(CONF_HOME)/MANIFEST.MF $(CLASSES_DIR)/MANIFEST.MF

doc:
	-mkdir -p $(DOC_DIR)
	$(JAVADOC) -J-mx100m -d $(DOC_DIR) edfreq/*.java


$(LOCAL_INSTALL_ROOT)/bin/freqEditor: Makefile
	@mkdir -p $(LOCAL_INSTALL_ROOT)/bin
	@printf \
	"#!/bin/csh -f\
	\n#########################################################################################\
	\n# This file has been automatically generated by \"gmake\" form the Makefile               #\
	\n#                                                                                       #\
	\n# For editing this script and keeping the modifications make a copy of this script in   #\
	\n# this directory and edit the copy.                                                     #\
	\n#########################################################################################\
	\n\
	\ncd \`dirname $$""0\`\
	\n\
	\nset JAVA = $(JAVA)\
	\n\
	\nset CLASSPATH = ../classes:$(shell cd $(shell dirname $(XERXES_JAR)); pwd)/xerces.jar\
	\n\
	\n$$""{JAVA} -classpath $$""{CLASSPATH} edfreq.FrontEnd \
	\n\
	\n" > $@

	@echo Creating $@
	@chmod 775 $@


$(LOCAL_INSTALL_ROOT)/bin/freqEditor.bat: Makefile
	@mkdir -p $(LOCAL_INSTALL_ROOT)/bin
	@printf \
	"echo off\
	\nrem #########################################################################################\
	\nrem # This file has been automatically generated by \"gmake\" form the Makefile               #\
	\nrem #                                                                                       #\
	\nrem # For editing this script and keeping the modifications make a copy of this script in   #\
	\nrem # this directory and edit the copy.                                                     #\
	\nrem #########################################################################################\
	\necho on\
	\necho Please cd into the directory containing the is script before running it. \
	\n\
	\nset JAVA=java \
	\n\
	\nset CLASSPATH=..\134classes;..\134..\134..\134ORAC\134tools\134xerces.jar \
	\n\
	\n\045JAVA\045 -classpath \045CLASSPATH\045 edfreq.FrontEnd \
	\n\
	\n" > $@

	@echo Creating $@


clean:
	rm -rf $(LOCAL_INSTALL_ROOT)/classes $(JAR_DIR) $(DOC_DIR)
	rm -f  $(LOCAL_INSTALL_ROOT)/bin/freqEditor $(LOCAL_INSTALL_ROOT)/bin/freqEditor.bat
	rm -rf $(LOCAL_INSTALL_ROOT)


###################################################################
#                    Installation                                 #
###################################################################


install: all
ifeq ($(INSTALL_ROOT),)
	@echo Usage: gmake "INSTALL_ROOT=myinstall_directory" install
else
	gmake _install
endif


_install:
	@mkdir -p $(INSTALL_ROOT)/lib

	jar cf $(INSTALL_ROOT)/lib/edfreq.jar -C $(LOCAL_INSTALL_ROOT)/classes .

	@mkdir -p $(INSTALL_ROOT)/tools
	cp ../../ORAC/tools/xerces.jar $(INSTALL_ROOT)/tools 

	@mkdir -p $(INSTALL_ROOT)/bin
	@printf \
	"#!/bin/csh -f\
	\n#########################################################################################\
	\n# This file has been automatically generated by \"gmake\" form the Makefile               #\
	\n#                                                                                       #\
	\n# For editing this script and keeping the modifications make a copy of this script in   #\
	\n# this directory and edit the copy.                                                     #\
	\n#########################################################################################\
	\n\
	\ncd \`dirname $$""0\`\
	\n\
	\nset JAVA = $(JAVA)\
	\n\
	\nset CLASSPATH = ../lib/edfreq.jar:$(shell cd $(shell dirname $(XERXES_JAR)); pwd)/xerces.jar\
	\n\
	\n$$""{JAVA} -classpath $$""{CLASSPATH} edfreq.FrontEnd \
	\n\
	\n" > $(INSTALL_ROOT)/bin/freqEditor

	@echo Creating $(INSTALL_ROOT)/bin/freqEditor
	@chmod 775 $(INSTALL_ROOT)/bin/freqEditor

	@printf \
	"echo off \
	\nrem #########################################################################################\
	\nrem # This file has been automatically generated by \"gmake\" form the Makefile               #\
	\nrem #                                                                                       #\
	\nrem # For editing this script and keeping the modifications make a copy of this script in   #\
	\nrem # this directory and edit the copy.                                                     #\
	\nrem #########################################################################################\
	\necho on \
	\necho Please cd into the directory containing the is script before running it. \
	\n\
	\nset JAVA=java \
	\n\
	\nset CLASSPATH=..\134lib\134edfreq.jar;..\134tools\134xerces.jar \
	\n\
	\n\045JAVA\045 -classpath \045CLASSPATH\045 edfreq.FrontEnd \
	\n\
	\n" > $(INSTALL_ROOT)/bin/freqEditor.bat

	@echo Creating $(INSTALL_ROOT)/bin/freqEditor.bat

